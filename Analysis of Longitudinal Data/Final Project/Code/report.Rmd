---
title: "Phase 2 Progress Report"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/timvigers/Documents/GitHub/School/Analysis of Longitudinal Data/Final Project")
library(rvest)
library(tableone)
library(skimr)
library(knitr)
library(tidyverse)
```

```{r import,echo=FALSE,cache=TRUE,include=FALSE}
# Get data from basketball reference
source("./Code/scrape.R")
# Read in passing CSV
passing <- read.csv("./Data/passing_data.csv")
# Colors
source("./Code/colors.R")
```

```{r data editing,echo=FALSE}
# Season to starting year
all_seasons$Season <- sub("-.*","",all_seasons$Season)
# Convert column types
numcols <- c("Season","AST","FG","3P")
all_seasons[,numcols] <- lapply(all_seasons[,numcols], 
                                function(x) as.numeric(as.character(x)))
```

# Data

I started out by downloading all the advanced passing data from `https://stats.nba.com/teams/passing/`. Unfortunately this only goes back 6 years, so I am going to have to look at assist data as well. The NBA has been counting assists since the 1940s, but these data are much more subjective than counting passes made. Whether a pass leads to a basket is entirely up to the scorekeepers' judgement, and there have been some famously questionable passes that were credited with an assist but probably should not have counted:

<iframe width="560" height="315" src="https://streamable.com/s/edf3x/sgvaae" frameborder="0" allowfullscreen></iframe>

## Passing Data Summary

```{r pass summary,echo=FALSE}
t1 <- CreateTableOne(vars = c("W","Passes.Made","Passes.Received","Ast",
                              "Secondary.Ast","Potential.Ast","Ast.Pts.Created"),
                     strata = "Team",data = passing)
t1 <- t(as.data.frame(print(t1)))
t1 <- t1[,-c(1)]
kable(t1)
```

## Basic Data Summary

```{r pass summary,echo=FALSE}
t1 <- CreateTableOne(vars = c("FG","FGA","FG%","3P","3PA","3P%","AST","STL",
                              "BLK","TOV","PF","PTS","AST%"),
                     strata = "Team",data = all_seasons)
t1 <- t(as.data.frame(print(t1)))
t1 <- t1[,-c(1)]
kable(t1)
```

# Plots

First I looked at raw assist numbers by team and season:

```{r raw assists,echo=FALSE,warning=FALSE,message=FALSE}
# Raw assist number plot
ast_plot <- 
  ggplot(all_seasons[all_seasons$Season > 1976,],aes(x = Season,y = AST,group = Team)) + 
  geom_line(aes(color = Team)) + theme_bw() +
  scale_color_manual(values = primary_colors)
ast_plot
```

I forgot about the lockout seasons in 1998 and 2011, so I'll have to look at percentages or exclude those years. However, this is a good check that my data scraping function worked correctly. It does look like there could be an overall sinusoid trend though, which is interesting.

Next, I plotted the percentage of baskets assisted. This time I also split the plot into individual teams:

```{r pct ast,echo=FALSE,warning=FALSE,message=FALSE}
# Percentage of baskets assisted
all_seasons <- all_seasons %>%
  mutate(`AST%` = round(AST / FG,3)*100)
# Plot assist percentage by year and team
# All together
ast_perc_plot <- 
  ggplot(all_seasons[all_seasons$Season > 1976,],aes(x = Season,y = `AST%`,group = Team)) + 
  geom_line(aes(color = Team)) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("Percentage of Baskets Assisted Per Team") + 
  scale_color_manual(values = primary_colors)
ast_perc_plot
# Facet wrap
ast_perc_plot +
  facet_wrap(~Team) + 
  theme(legend.position = "none")
```

These plots look a little bit flatter to me, but it still looks like there's an up and down trend. It would be worth checking for at least a cubic effect of time. Two random interesting things that stood out to me are the assist trends for the Utah Jazz and Golden State Warriors:

```{r uta gsw,echo=FALSE,warning=FALSE,message=FALSE}
# All together
uta_gsw_plot <- 
  ggplot(all_seasons[all_seasons$Season > 1976 & all_seasons$Team %in% c("GSW","UTA"),],
         aes(x = Season,y = `AST%`,group = Team)) + 
  geom_line(aes(color = Team)) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("Percentage of Baskets Assisted Per Team") + 
  scale_color_manual(values = c(team_colors[["GSW"]][1],team_colors[["UTA"]][1])) +
  facet_wrap(~Team) + 
  theme(legend.position = "none")
uta_gsw_plot
```

Golden State has a sudden increase in assist percentage around 2012, which is close to when they began their dominant run. The numbers peak in 2016, when Stephen Curry was the unanimous MVP. In Utah, the percentage of assisted baskets is consistently high from about 1985 to the early 2000s, which corresponds with the career of John Stockton (the NBA's all-time leader in assists).

Because line graphs can be messy and hard to read, I plotted using Loess smoothing as well:

```{r pct ast loess,echo=FALSE,warning=FALSE,message=FALSE}
# Loess 
ast_perc_loess <- 
  ggplot(all_seasons[all_seasons$Season > 1976,],aes(x = Season,y = `AST%`,group = Team)) + 
  geom_smooth(aes(color = Team),se = F) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("Percentage of Baskets Assisted Per Team, Loess Smoothing") + 
  scale_color_manual(values = primary_colors)
ast_perc_loess
# Facet Loess
ast_perc_loess +
  facet_wrap(~Team) + 
  theme(legend.position = "none")
# Loess overall trend
ast_perc_loess_overall <- 
  ggplot(all_seasons[all_seasons$Season > 1976,],aes(x = Season,y = `AST%`)) + 
  geom_smooth() + theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("Percentage of Baskets Assisted League-Wide, Loess Smoothing")
ast_perc_loess_overall
```

These are a little messy as well, but the cubic trend is pretty obvious in the league-wide plot.

# Models