---
title: "Longitudinal Homework 6"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(MASS)
library(lme4)
library(nlme)
```

```{r data, echo=FALSE}
df <- read.csv("/Users/timvigers/Documents/GitHub/School/Analysis of Longitudinal Data/Homework 6/albuterol.csv")
```

# 1. Model planning

## a. Software

### i. Medication use

In order to adapt a generalized linear model (GzLM) for serially correlated data, I would use a generalized estimating equation (GEE). This could be fit using PROC GENMOD in SAS, with a Poisson distribution since this is count data. There is also a package called "geepack" in R that can fit GEEs, but I've never used it and don't know much about it, so PROC GENMOD is probably safer.

### ii. FEV1

I think you can probably get away with a normal theory model for FEV1 data, unless it's really skewed. If so, I would use either PROC MIXED in SAS or gls() in R. If normal theory models won't work, then I would use PROC GENMOD or geeglm() like above, to model the outcome with a non-normal distribution.

## b. Data

### i. Medication use

Because we need a GEE for this outcome, I would set up the data so that each subject has a row for every day during the relevant timeframe. On days without an albuterol count the outcome would be filled in as missing (NA in R), but the temporal spacing would be equal between rows within subject.

The SAS code would look something like:

```{sas eval=FALSE}
proc genmod data=albuterol;
class id friday;
model albuterol_use = 
  friday ln_mmax_pm25 temperature pressure humidity / solution dist=poisson;
repeated subject=id / TYPE = AR(1);
run;
```

## c. Binary outcome

### i. Medication use

In order to fit a GzLMM model with a random intercept for subject, I would use PROC GLIMMIX in SAS (with distribution = binary). PROC NLMIXED would also work, but I find it a little more confusing. The default in PROC GLIMMIX is to approximate the true likelihood using Laplace's method, but you can also specify method = quad to use Gaussian quadrature. This can also be done using glmer() in R. 

### ii. FEV1

Again assuming that the normal theory model is okay for FEV1, I would use PROC MIXED in SAS or lme() in R (or possible lmer() to be consistent with the model above). These models would be fit using ML or REML rather than Gaussian quadrature.

for an AR(1) correlation structure in the repeated measures, but does not allow for the incorporation of random effects. GEEs can be fit (using the same data structure as above) with:

##d. Random intercept and serial correlation

### i. Medication use

Correlated count data like this probably requires a generalized linear mixed model (GzLMM) where the outcome is modeled as Poisson-distributed, a random intercept for subject, and with an AR(1) or spatial power correlation for repeated measures. I think the best way to do this in SAS is to use PROC GLIMMIX, and in R glmmPQL() should work. 

There isn't a REPEATED statement in PROC GLIMMIX, so you need to another random effect with the "_residual_" and the correlation structure:

```{sas eval=FALSE}
proc glimmix data=albuterol;
model albuterol_use = 
  friday ln_mmax_pm25 temperature pressure humidity / solution distribution=poisson;
random intercept / subject=id;
random _residual_ / subject=id type=ar(1); 
run;
```

The R code would be something like:

```{r eval=FALSE}
glmmPQL(fixed = albuterol_use ~ friday + ln_mmax_pm25 + temperature + pressure + humidity,
        random = ~1|id, family = "poisson",correlation = corAR1(),
        data = df)
```

### ii. FEV1

These normal models could be fit using either PROC MIXED in SAS or lme() in R. I don't know how to include the AR(1) structure in lmer(), but I'm sure it's possible.

The SAS code would be something like:

```{sas eval=FALSE}
proc mixed data=albuterol;
class id friday;
model fev1 = 
  friday ln_mmax_pm25 temperature pressure humidity / solution;
random intercept / subject=id;
repeated / type=AR(1) subject=id; 
run;
```

And the R code something like:

```{r eval=FALSE}
lme(fev1 ~ friday + ln_mmax_pm25 + temperature + pressure + humidity,
    random = ~1|id,correlation = corAR1(),data = df,na.action = na.omit)
```

# 2. Albuterol data

## a. GEE

The results of PROC GENMOD are below, with the scale parameter in the red box:

![](/Users/timvigers/Documents/GitHub/School/Analysis of Longitudinal Data/Homework 6/2a.png)

Adding the scale parameter increases the standard errors.

## b. GzLMM



# Questions

## 1. 

### What are the drawbacks to Guassian quad/approximating the true likelihood?

### Gaussian quad vs. ML?

## 2. 

### How do you compare apples to apples when fitting with RSPL?