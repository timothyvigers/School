---
title: "BIOS 7659 Homework 8"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,dpi=600)
knitr::opts_knit$set(root.dir = "/Users/timvigers/GitHub/School/Statistical Genomics/hw8")
library(FlowSorted.Blood.450k)
library(quadprog)
library(IlluminaHumanMethylation450kmanifest)
library(flextable)
library(tidyverse)
```

# 1. Cell Type Composition

Read in the data:

```{r message=FALSE,warning=FALSE}
baseDir1 = "blood/plate1"
targets1 = read.metharray.sheet(baseDir1)
baseDir2 = "blood/plate2"
targets2 = read.metharray.sheet(baseDir2)
targets = rbind(targets1, targets2)
rgSet = read.metharray.exp(targets=targets,extended=T)
sampleNames(rgSet) = rgSet[[1]]
getManifest(rgSet)
clindat = read.table("blood/demographic.txt", sep="\t", header=T)
pData(rgSet)$Sample_Group = clindat$Exposure
pData(rgSet)$child_sex = clindat$child_sex
```

## a) Find differentially methylated positions based on exposure status

```{r}
# SWAN normalization
msetSWAN = preprocessSWAN(rgSet)
dmp = dmpFinder(msetSWAN,pheno = msetSWAN$Sample_Group,type = "continuous")
```

Here the unexposed group is the reference, so a negative value of beta in the DMP table indicates that the probe was hypomethylated in the exposed group (and a positive value indicates hypermethylation). There are no probes significant at the $q<0.1$ level, but there are `r sum(dmp$pval<1e-5,na.rm = T)` significant at the $p<10^{-5}$ level:

```{r}
dmp %>% rownames_to_column(var="Probe") %>% filter(pval < 1e-5) %>%
  mutate(Direction = ifelse(sign(beta)==-1,"Hypomethylated","Hypermethylated")) %>%
  select(Probe,beta,Direction,pval) %>% rename("Beta"=beta,"P Value"=pval) %>%
  flextable(.) %>% footnote(.,i=1,j=3,value = as_paragraph("With respect to exposure"),
                            ref_symbols = "*",part = "header") %>%
  set_table_properties(.,layout = "autofit",width = 0.5)
```


