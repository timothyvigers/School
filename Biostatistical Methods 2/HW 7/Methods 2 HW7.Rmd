---
title: "Homework 7"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(nlme)
library(knitr)
library(emmeans)
```

## 1. Linear mixed model

### a. Provide an interpretation for each parameter in the fixed effects model.

$$
\beta_0=\text{Average gall bladder volume for a dog in the control group at time 0}\\
\beta_1=\text{The average effect of a "1 unit increase" in time in the control group, holding everything else constant}\\
\beta_2=\text{The average effect of treatment at time 0, holding everything else constant}\\
\beta_3=\text{The interaction effect of time and treatment}
$$

### b. Is time being treated as continuous or categorical in this model?

Time is being treated as continuous, because there is one term for time, rather than a term for each timepoint. 

### c. Random intercept model
$$
\textbf{R}_i = \begin{pmatrix}
\sigma^2_e & \dots&0\\
\vdots & \ddots& \vdots \\
0&\dots& \sigma^2_e
\end{pmatrix}_{r_i\times r_i}
$$

### d. Model without random intercept
$$
\textbf{R}_i = \begin{pmatrix}
\sigma^2_I + \sigma^2_e&\dots&\sigma^2_I\\
\vdots & \ddots& \vdots \\
\sigma^2_I&\dots& \sigma^2_I + \sigma^2_e
\end{pmatrix}_{r_i\times r_i}
$$

## 2. Dog data

```{r}
# Read in data
dogs <- read.csv("/Users/timvigers/Documents/School/Biostatistical Methods 2/Homeworks/Homework 7/dogdata_long.csv")
# Format columns
dogs$minutes <- as.factor(dogs$minutes)
# Models
mod <- lme(GBV ~ trt * minutes, random = ~1|id,data = dogs)
mean_mod <- lme(GBV ~ trt:minutes-1, random = ~1|id,data = dogs)
```

### a. Why might adding a random intercept for dogs (relative to the same model but without the random term) help the model?

Each dog is being measured multiple times, so the random intercept for dogs will help account for correlation between these measurements. 

### b. Is there a mean difference between the two drug groups (Cholechystokynin and Clanobutin) for at least one time point?

$$
H_0:(\mu_{1|0}=\mu_{2|0}=\mu_{1|30}=\mu_{2|30}=\mu_{1|60}=\mu_{2|60}=\mu_{1|90}=\mu_{2|90}=\mu_{1|120}=\mu_{2|120})
$$

```{r}
# Contrast at minute 0
cmat <- rbind(c(-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0),
              c(0,0,0,-1,1,0,0,0,0,0,0,0,0,0,0),
              c(0,0,0,0,0,0,-1,1,0,0,0,0,0,0,0),
              c(0,0,0,0,0,0,0,0,0,-1,1,0,0,0,0),
              c(0,0,0,0,0,0,0,0,0,0,0,0,-1,1,0))
numerator <- cmat %*% summary(mean_mod)$tTable[,1]
f1 <- t(numerator) %*% solve(cmat %*% vcov(mean_mod) %*% t(cmat)) %*% numerator
f1
pf(f1,1,((nrow(dogs)-1)-(nrow(summary(mean_mod)$tTable)-1)-(length(unique(dogs$id))-1)),lower.tail=FALSE) # Lecture 17 pg. 35
```