---
title: "Homework 3"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(pROC)
```

```{r}
# Read in
copd <- read.csv("~/Documents/School/UC Denver/Biostatistics/Biostatistical Methods 2/Homeworks/Homework 3/hw3.txt", sep="")
# Format factor columns
copd[,c("copd","gender","smoker")] <- lapply(copd[,c("copd","gender","smoker")], as.factor)
```
## 1. COPD Models
```{r}
# Model 1 with BMI squared
mod1 <- glm(copd ~ age + gender + smoker + BMI + BMIsquared, data = copd,family = "binomial")
```
###a. Determine whether COPD is significantly associated with BMI squared using Wald statistic.
```{r}
# Calculate Wald statistic
wald <- (coef(mod1)[6]/sqrt(diag(vcov(mod1)))[6])^2
wald
```
$$
\text{Wald statistic}=7.309
$$
Test against chi-squared distribution (1 DF):
```{r}
1 - pchisq(7.309,1)
```
Based on the Wald statistic, BMI squared is significantly associated with COPD (p = 0.007).

###b. Determine whether COPD is significantly associated with BMI squared using LRT.
```{r}
# Model without BMI squared
mod0 <- glm(copd ~ age + gender + smoker + BMI, data = copd,family = "binomial")
# LL for model 0 and model 1
LL0 <- logLik(mod0)
LL1 <- logLik(mod1)
LL0
LL1
```
$$
\text{Likelihood ratio statistic}=2(LL1 - LL0)=7.953
$$
Test against chi-squared distribution (1 DF):
```{r}
1 - pchisq(7.953,1)
```
Check with R:
```{r}
anova(mod0,mod1, test = "LRT")
```
###c. AUC (c index)
Compare the predictive accuracy of each model. Model 0 (without BMI squared):
```{r}
copd$prob_mod0 <- predict(mod0,type = "response")
roc_mod0 <- pROC::roc(copd ~ prob_mod0, data = copd)
roc_mod0
```
Model 1 (with BMI squared):
```{r}
copd$prob_mod1 <- predict(mod1,type = "response")
roc_mod1 <- pROC::roc(copd ~ prob_mod1, data = copd)
roc_mod1
```
$$
\text{AUC without }\text{BMI}^2=0.705\\
    \\
\text{AUC with }\text{BMI}^2=0.712
$$
The difference in predictive power between the two models is not particularly large, but the model with BMI squared is slightly better.

###d. Is there evidence that COPD has a quadratic relationship with BMI?
Both the Wald statistic and likelihood ratio test suggest that $\text{BMI}^2$ contributes significantly to the model. Also, the model including $\text{BMI}^2$ has slightly higher predictive power than the model without $\text{BMI}^2$. Therefore, all of the evidence suggests that there is a quadratic relationship between BMI and presence of COPD.

###e. Why do you think the BMI variable was centered?
I would guess that there was an issue with multicollinearity for BMI. Mean-centering a predictor variable can reduce multicollinearity, and does not require categorizing the variable (so you aren't throwing out as much information).

###f. Calculate and interpret the estimated odds ratio for the effect of BMI on COPD for a patient with average BMI.

By inverting a Wald test:
$$
\text{95% CI}=(e^{\hat\beta_\text{BMI}-1.96*SE(\hat\beta_\text{BMI})},e^{\hat\beta_\text{BMI}+1.96*SE(\hat\beta_\text{BMI})})
$$

Because we are interested in an average BMI and BMI is mean-centered for this dataset, we want to use a BMI of 0:
$$
(e^{\hat\beta_\text{BMI}-1.96*SE(\hat\beta_\text{BMI})},e^{\hat\beta_\text{BMI}+1.96*SE(\hat\beta_\text{BMI})})=(e^{-0.045133-1.96*(0.015116)},e^{-0.045133+1.96*(0.015116)}) = (e^{-0.075},e^{-0.016})=(0.928,0.984)
$$

By inverting a LRT, solve the equation:
$$
2\text{ log}(\frac{L(\hat\beta_0,\hat\beta_1)}{L(\tilde\beta_0|\beta_1=\beta_1^{*})})=3.841
$$

This is tough to solve by hand, so use R's confint() function:
```{r}
confint(mod1)
```

Check the Wald interval as well, using confint.default():
```{r}
confint.default(mod1)
```